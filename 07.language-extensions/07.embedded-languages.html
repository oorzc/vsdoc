<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.53" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="https://oorzc.cn/07.language-extensions/07.embedded-languages.html"><meta property="og:site_name" content="vscode插件开发文档"><meta property="og:title" content="嵌入语言"><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><link href="https://cdn.jsdelivr.net/npm/@docsearch/css@3" rel="stylesheet"><link rel="icon" href="/favicon.ico"><link rel="icon" href="/icons/apple-touch-icon.png" type="image/png" sizes="512x512"><link rel="icon" href="/icons/apple-touch-icon.png" type="image/png" sizes="192x192"><link rel="manifest" href="/manifest.webmanifest" crossorigin="use-credentials"><meta name="theme-color" content="#fff"><link rel="apple-touch-icon" href="/icons/apple-touch-icon.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="msapplication-TileImage" content="/icons/apple-touch-icon.png"><meta name="msapplication-TileColor" content="#ffffff"><title>嵌入语言 | vscode插件开发文档</title><meta name="description" content="vscode插件开发文档">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d2025;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.querySelector("html").setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/assets/style.28776aee.css" as="style" /><link rel="stylesheet" href="/assets/style.28776aee.css" />
    <link rel="modulepreload" href="/assets/app.ed9f300c.js"><link rel="modulepreload" href="/assets/07.embedded-languages.html.2ac81f97.js"><link rel="modulepreload" href="/assets/_plugin-vue_export-helper.cdc0426e.js"><link rel="modulepreload" href="/assets/07.embedded-languages.html.f10fb7b7.js">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="skip-link sr-only">Skip to content</a><!--]--><div class="theme-container has-toc"><!--[--><!--[--><header class="navbar"><div class="navbar-left"><button class="toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><a href="/" class="brand"><img class="logo" src="/logo.jpg" alt="vscode插件开发文档"><!----><span class="site-name hide-in-pad">vscode插件开发文档</span></a><!--[--><!----><!--]--></div><div class="navbar-center"><!--[--><!----><!--]--><!----><!--[--><!----><!--]--></div><div class="navbar-right"><!--[--><!----><!--]--><!----><!----><div class="nav-item hide-in-mobile"><button id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><div id="docsearch-container"></div><!--[--><!----><!--]--><button class="toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span class="button-container"><span class="button-top"></span><span class="button-middle"></span><span class="button-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow left"></span></div><aside class="sidebar"><!--[--><!----><!--]--><ul class="sidebar-links"><li><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">预备知识</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">api</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">第一步</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">开发插件</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">插件功能</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">插件指南</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable active"><!----><span class="title">语言插件</span><span class="arrow down"></span></button><ul class="sidebar-links"><li><!--[--><a href="/07.language-extensions/01.syntax-highlight-guide.html" class="nav-link sidebar-link sidebar-page" aria-label="语法高亮"><!---->语法高亮<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/07.language-extensions/02.semantic-highlight-guide.html" class="nav-link sidebar-link sidebar-page" aria-label="语义高亮指南"><!---->语义高亮指南<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/07.language-extensions/03.snippet-guide.html" class="nav-link sidebar-link sidebar-page" aria-label="代码片段"><!---->代码片段<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/07.language-extensions/04.language-configuration-guide.html" class="nav-link sidebar-link sidebar-page" aria-label="语言配置"><!---->语言配置<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/07.language-extensions/05.programmatic-language-features.html" class="nav-link sidebar-link sidebar-page" aria-label="程序性语言特性"><!---->程序性语言特性<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/07.language-extensions/06.language-server-extension-guide.html" class="nav-link sidebar-link sidebar-page" aria-label="示例：语言服务器"><!---->示例：语言服务器<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-current="page" href="/07.language-extensions/07.embedded-languages.html" class="router-link-active router-link-exact-active nav-link active sidebar-link sidebar-page active" aria-label="嵌入语言"><!---->嵌入语言<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/07.language-extensions/07.embedded-languages.html#语言服务" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="语言服务"><!---->语言服务<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/07.language-extensions/07.embedded-languages.html#语言服务示例" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="语言服务示例"><!---->语言服务示例<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/07.language-extensions/07.embedded-languages.html#请求转发" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="请求转发"><!---->请求转发<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/07.language-extensions/07.embedded-languages.html#请求转发示例" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="请求转发示例"><!---->请求转发示例<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/07.language-extensions/07.embedded-languages.html#潜在问题" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="潜在问题"><!---->潜在问题<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/07.language-extensions/07.embedded-languages.html#很难实现语言特性" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="很难实现语言特性"><!---->很难实现语言特性<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/07.language-extensions/07.embedded-languages.html#语言服务器的状态太多而无法嵌入" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="语言服务器的状态太多而无法嵌入"><!---->语言服务器的状态太多而无法嵌入<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/07.language-extensions/07.embedded-languages.html#编码和解码" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="编码和解码"><!---->编码和解码<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/07.language-extensions/07.embedded-languages.html#总结" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="总结"><!---->总结<!----></a><ul class="sidebar-sub-headers"></ul></li></ul><!--]--></li><li><!--[--><a href="/07.language-extensions/" class="nav-link sidebar-link sidebar-page" aria-label="概述"><!---->概述<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">进阶主题</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">️️参考</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">其他1</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">其他2</span><span class="arrow right"></span></button><!----></section></li></ul><!--[--><!----><!--]--></aside><!--[--><main class="page" id="main-content"><!--[--><!----><nav class="breadcrumb disable"></nav><div class="page-title"><h1><!---->嵌入语言</h1><div class="page-info"><span class="author-info" aria-label="作者🖊" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><span class="author-item">oorzc</span></span><span property="author" content="oorzc"></span></span><!----><!----><span class="reading-time-info" aria-label="阅读时间⌛" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 9 分钟</span><meta property="timeRequired" content="PT9M"></span><span class="words-info" aria-label="字数🔠" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon word-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="word icon"><path d="M518.217 432.64V73.143A73.143 73.143 0 01603.43 1.097a512 512 0 01419.474 419.474 73.143 73.143 0 01-72.046 85.212H591.36a73.143 73.143 0 01-73.143-73.143z"></path><path d="M493.714 566.857h340.297a73.143 73.143 0 0173.143 85.577A457.143 457.143 0 11371.566 117.76a73.143 73.143 0 0185.577 73.143v339.383a36.571 36.571 0 0036.571 36.571z"></path></svg><span>约 2822 字</span><meta property="wordCount" content="2822"></span></div><hr></div><div class="toc-place-holder"><aside id="toc"><div class="toc-header">此页内容</div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/07.language-extensions/07.embedded-languages.html#语言服务" class="router-link-active router-link-exact-active toc-link level2">语言服务</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/07.language-extensions/07.embedded-languages.html#语言服务示例" class="router-link-active router-link-exact-active toc-link level3">语言服务示例</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/07.language-extensions/07.embedded-languages.html#请求转发" class="router-link-active router-link-exact-active toc-link level2">请求转发</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/07.language-extensions/07.embedded-languages.html#请求转发示例" class="router-link-active router-link-exact-active toc-link level3">请求转发示例</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/07.language-extensions/07.embedded-languages.html#潜在问题" class="router-link-active router-link-exact-active toc-link level2">潜在问题</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/07.language-extensions/07.embedded-languages.html#很难实现语言特性" class="router-link-active router-link-exact-active toc-link level3">很难实现语言特性</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/07.language-extensions/07.embedded-languages.html#语言服务器的状态太多而无法嵌入" class="router-link-active router-link-exact-active toc-link level3">语言服务器的状态太多而无法嵌入</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/07.language-extensions/07.embedded-languages.html#编码和解码" class="router-link-active router-link-exact-active toc-link level3">编码和解码</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/07.language-extensions/07.embedded-languages.html#总结" class="router-link-active router-link-exact-active toc-link level2">总结</a></li><!----><!--]--></ul></div></aside></div><!----><div class="theme-hope-content"><h1 id="嵌入语言" tabindex="-1"><a class="header-anchor" href="#嵌入语言" aria-hidden="true">#</a> 嵌入语言</h1><hr><p>VS Code 为编程语言提供了丰富的功能。就如你在 <a href="/language-extensions/language-server-extension-guide">语言服务器</a> 中看到的那样，语言服务器可以支持任何编程语言。但要支持嵌入的语言，我们还要做更多工作。</p><p>时至今日，嵌入语言日与俱增，比如：</p><ul><li>HTML 中的 JavaScript 和 CSS</li><li>JavaScript 中的 JSX</li><li>模板语法，比如 Vue，Handlebars 和 Razor</li><li>PHP 中的 HTML</li></ul><p>本篇指南着重于实现嵌入语言的各种语言功能。如果你只是对嵌入语言的语法高亮感兴趣，请参考<a href="/language-extensions/syntax-highlight-guide">语法高亮指南</a>。</p><p>本指南包含两个示例，它们介绍了 2 种构建嵌入语言服务器的方法——<strong>语言服务</strong>和<strong>请求转发</strong>。我们将学习这两个示例，并了解它们各自的优点和缺点。</p><p>示例代码见下：</p><ul><li><a href="https://github.com/microsoft/vscode-extension-samples/tree/master/lsp-embedded-language-service" target="_blank" rel="noopener noreferrer">嵌入语言服务器（语言服务实现）<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://github.com/microsoft/vscode-extension-samples/tree/master/lsp-embedded-request-forwarding" target="_blank" rel="noopener noreferrer">嵌入语言服务器（请求转发实现）<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li></ul><p>我们先看看我们要构建的嵌入语言服务器实现的效果：</p><p><img src="https://code.visualstudio.com/assets/api/language-extensions/embedded-languages/embedded-lsp-sample.gif" alt="embedded languages"></p><p>两个示例都分别配置了一个新的语言——<code>html1</code>。你可以创建一个<code>.html1</code>文件，然后测试下列功能：</p><ul><li>HTML 标签的自动填充</li><li><code>&lt;style&gt;</code>标签中 CSS 的自动填充功能</li><li>CSS 语法诊断（仅在<strong>语言服务</strong>实现中可用）</li></ul><h2 id="语言服务" tabindex="-1"><a class="header-anchor" href="#语言服务" aria-hidden="true">#</a> 语言服务</h2><hr><p><strong>语言服务</strong>是实现了<a href="https://code.visualstudio.com/api/language-extensions/programmatic-language-features" target="_blank" rel="noopener noreferrer">程序性语言功能<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>的库。<strong>语言服务器</strong>可嵌入到语言服务中，解决嵌入语言的各类问题。</p><p>下面是 VS Code 为 HTML 提供的功能大纲：</p><ul><li>内建的 <a href="https://github.com/microsoft/vscode/tree/master/extensions/html" target="_blank" rel="noopener noreferrer">html 插件<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 只提供了语法高亮和 HTML 的语言配置能力</li><li>内建的 <a href="https://github.com/microsoft/vscode/tree/master/extensions/html-language-features" target="_blank" rel="noopener noreferrer">html 语言功能插件<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>包含 HTML 语言服务器，为 HTML 提供程序性语言特性</li><li>HTML 语言服务器使用 <a href="https://github.com/microsoft/vscode-html-languageservice" target="_blank" rel="noopener noreferrer">vscode-html-languageservice<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 支持 HTML</li><li>CSS 语言服务器使用 <a href="https://github.com/microsoft/vscode-css-languageservice" target="_blank" rel="noopener noreferrer">vscode-css-languageservice<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 支持 HTML 中的 CSS</li></ul><p>HTML 语言服务器分析 HTML 文档，将其分解为<strong>语言域</strong>，然后使用对应的<strong>语言服务</strong>处理语言服务器的请求。</p><p>比如：</p><ul><li><code>&lt;|</code> 的自动补全请求，HTML 语言服务器使用 HTML 语言服务提供 HTML 的自动补全。</li><li><code>&lt;style&gt;.foo { | }&lt;/style&gt;</code> 的自动补全请求，HTML 语言服务器则使用 CSS 语言服务器提供 CSS 补全功能。</li></ul><p>现在让我们在 <a href="https://github.com/microsoft/vscode-extension-samples/tree/master/lsp-embedded-language-service" target="_blank" rel="noopener noreferrer">lsp-embedded-language-service<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 示例中检验一下。</p><h3 id="语言服务示例" tabindex="-1"><a class="header-anchor" href="#语言服务示例" aria-hidden="true">#</a> 语言服务示例</h3><p>!&gt; 注意: 本示例假设你已经掌握了 <a href="https://code.visualstudio.com/api/language-extensions/programmatic-language-features" target="_blank" rel="noopener noreferrer">程序性语言特性<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 和 <a href="/language-extensions/language-server-extension-guide">语言服务器</a> 这2章内容。本示例构建于 <a href="https://github.com/microsoft/vscode-extension-samples/tree/master/lsp-sample" target="_blank" rel="noopener noreferrer">lsp-sample<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>与 <a href="https://github.com/microsoft/vscode-extension-samples/tree/master/lsp-sample" target="_blank" rel="noopener noreferrer">lsp-sample<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 相同的是，本示例的客户端代码都是一样的。</p><p>我们刚刚在上面提到了，服务器会将文档切分为不同的<strong>语言域</strong>，然后分别处理对应的嵌入内容。</p><p>我看个简单示例</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css"><span class="token selector">.foo</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>这个例子里，服务器检测到<code>&lt;style&gt;</code>标签，然后将 <code>.foo{ }</code> 标记为 <strong>CSS 域</strong>。</p><p>特定位置产生的自动补全请求，服务器会遵循下列逻辑返回响应对象：</p><ul><li>如果当前位置属于**“域”** <ul><li>为域中的语言生成一份虚拟文档，其他域则使用空白符填充</li></ul></li><li>如果当前位置不属于任何**“域”** <ul><li>使用 HTML 虚拟文档处理，所有域都视为空白符</li></ul></li></ul><p>比如，当我在下列光标位置使用自动补全</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css"><span class="token selector">.foo</span> <span class="token punctuation">{</span> | <span class="token punctuation">}</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>服务器会现当前位置在**“域”**中，然后生成一个虚拟 CSS 文档，该文档包含下面的内容（█ 表示空白符）</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code>███████████
███████.foo { | }████████
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>服务器随后使用 <code>vscode-css-languageservice</code> 分析该文档，然后计算出一个自动补全项的列表。因为现在内容不包含 HTML 了，所以 CSS 语言服务器就可以轻松地处理了。通过将非CSS 内容替换为空白符，我们就不用手动处理语言事件发生的具体位置和偏移位置了。</p><p>处理补全请求的服务端代码：</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code>connection<span class="token punctuation">.</span><span class="token function">onCompletion</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span>textDocumentPosition<span class="token punctuation">,</span> token<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> document <span class="token operator">=</span> documents<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>textDocumentPosition<span class="token punctuation">.</span>textDocument<span class="token punctuation">.</span>uri<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>document<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> mode <span class="token operator">=</span> languageModes<span class="token punctuation">.</span><span class="token function">getModeAtPosition</span><span class="token punctuation">(</span>document<span class="token punctuation">,</span> textDocumentPosition<span class="token punctuation">.</span>position<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mode <span class="token operator">||</span> <span class="token operator">!</span>mode<span class="token punctuation">.</span>doComplete<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> CompletionList<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> doComplete <span class="token operator">=</span> mode<span class="token punctuation">.</span>doComplete<span class="token operator">!</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token function">doComplete</span><span class="token punctuation">(</span>document<span class="token punctuation">,</span> textDocumentPosition<span class="token punctuation">.</span>position<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>CSS 模型则负责处理落入 CSS 域的所有语言服务器请求</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">getCSSMode</span><span class="token punctuation">(</span>
  cssLanguageService<span class="token operator">:</span> CSSLanguageService<span class="token punctuation">,</span>
  documentRegions<span class="token operator">:</span> LanguageModelCache<span class="token operator">&lt;</span>HTMLDocumentRegions<span class="token operator">&gt;</span>
<span class="token punctuation">)</span><span class="token operator">:</span> LanguageMode <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token string">&#39;css&#39;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">doComplete</span><span class="token punctuation">(</span>document<span class="token operator">:</span> TextDocument<span class="token punctuation">,</span> position<span class="token operator">:</span> Position<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Get virtual CSS document, with all non-CSS code replaced with whitespace</span>
      <span class="token keyword">const</span> embedded <span class="token operator">=</span> documentRegions<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getEmbeddedDocument</span><span class="token punctuation">(</span><span class="token string">&#39;css&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Compute a response with vscode-css-languageservice</span>
      <span class="token keyword">const</span> stylesheet <span class="token operator">=</span> cssLanguageService<span class="token punctuation">.</span><span class="token function">parseStylesheet</span><span class="token punctuation">(</span>embedded<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> cssLanguageService<span class="token punctuation">.</span><span class="token function">doComplete</span><span class="token punctuation">(</span>embedded<span class="token punctuation">,</span> position<span class="token punctuation">,</span> stylesheet<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这是个处理嵌入语言非常简单有效的办法。但是这个方法也有很多问题：</p><ul><li>你需要持续更新维护<strong>语言服务器</strong>依赖的<strong>语言服务</strong></li><li>你的<strong>语言服务器</strong>很难引入一个非同语言实现的<strong>语言服务</strong>。比如用 PHP 实现的 PHP 语言服务器很难接入 TypeScript实现的 <code>vscode-css-languageservice</code>。</li></ul><p>别急，我们马上来实现 <code>请求转发</code> 解决上面的问题。</p><h2 id="请求转发" tabindex="-1"><a class="header-anchor" href="#请求转发" aria-hidden="true">#</a> 请求转发</h2><hr><p>简单来说，请求转发和语言服务的工作机制是类似的。请求转发方法，也接收语言服务器的请求，计算虚拟文档，然后返回结果。</p><p>主要的不同点在于：</p><ul><li>语言服务使用<strong>库</strong>去响应语言语言服务器，而请求转发则把请求发送回 VS Code 查询所有的语言服务器，然后转发它们的处理结果。</li><li>分发工作由语言客户端处理，而不是语言服务器</li></ul><p>我们再来看下这个例子：</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css"><span class="token selector">.foo</span> <span class="token punctuation">{</span> | <span class="token punctuation">}</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>补全工作的流程像这样：</p><ul><li>语言客户端为<code>embedded-content</code> 注册一个虚拟文本文档供应器函数（<code>workspace.registerTextDocumentContentProvider</code>）</li><li>语言服务器劫取<code>&lt;FILE_URI&gt;</code>的补全请求</li><li>语言服务器确定请求位置落入 <strong>CSS 域</strong></li><li>语言服务器构建一个新的 URI，比如 <code>embedded-content://css/&lt;FILE_URI&gt;.css</code></li><li>然后服务器调用 <code>commands.executeCommand(&#39;vscode.executeCompletionItemProvider&#39;, ...)</code><ul><li>VS Code 的 CSS 语言服务器响应该请求</li><li>虚拟文本文档供应器函数，给 CSS 语言服务器提供虚拟文档内容，其中所有非 CSS 的代码都已经被替换为空白符</li><li>语言客户端接收到 VS Code 的响应，然后返回该响应</li></ul></li></ul><p>这样一来，即使我们的代码不包含 CSS 处理库，也能够完成 CSS 的自动补全。而且 VS Code 更新 CSS 语言服务器的时候，我们的插件不用改动一行代码也获得了最新的 CSS 支持。</p><p>现在，我们来看看示例代码：</p><h3 id="请求转发示例" tabindex="-1"><a class="header-anchor" href="#请求转发示例" aria-hidden="true">#</a> 请求转发示例</h3><p>!&gt; 注意: 本示例假设你已经掌握了 <a href="https://code.visualstudio.com/api/language-extensions/programmatic-language-features" target="_blank" rel="noopener noreferrer">程序性语言特性<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 和 <a href="/language-extensions/language-server-extension-guide">语言服务器</a> 这2章内容。本示例构建于 <a href="https://github.com/microsoft/vscode-extension-samples/tree/master/lsp-sample" target="_blank" rel="noopener noreferrer">lsp-sample<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>建立文档 URI 和它们对应虚拟文档的映射，根据这个映射提供对应的请求：</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">const</span> virtualDocumentContents <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token operator">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

workspace<span class="token punctuation">.</span><span class="token function">registerTextDocumentContentProvider</span><span class="token punctuation">(</span><span class="token string">&#39;embedded-content&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">provideTextDocumentContent</span><span class="token operator">:</span> uri <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 移除前置 `/` 和结尾的 `.css`，获取原始 URI</span>
    <span class="token keyword">const</span> originalUri <span class="token operator">=</span> uri<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> decodedUri <span class="token operator">=</span> <span class="token function">decodeURIComponent</span><span class="token punctuation">(</span>originalUri<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> virtualDocumentContents<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>decodedUri<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>通过使用语言客户端的<code>middleware</code>，我们劫持了自动补全请求：</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">let</span> clientOptions<span class="token operator">:</span> LanguageClientOptions <span class="token operator">=</span> <span class="token punctuation">{</span>
  documentSelector<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> scheme<span class="token operator">:</span> <span class="token string">&#39;file&#39;</span><span class="token punctuation">,</span> language<span class="token operator">:</span> <span class="token string">&#39;html&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  middleware<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">provideCompletionItem</span><span class="token operator">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>document<span class="token punctuation">,</span> position<span class="token punctuation">,</span> context<span class="token punctuation">,</span> token<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果不在 `&lt;style&gt;`中, 不使用请求转发</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>
        <span class="token operator">!</span><span class="token function">isInsideStyleRegion</span><span class="token punctuation">(</span>
          htmlLanguageService<span class="token punctuation">,</span>
          document<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          document<span class="token punctuation">.</span><span class="token function">offsetAt</span><span class="token punctuation">(</span>position<span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
      <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span>document<span class="token punctuation">,</span> position<span class="token punctuation">,</span> context<span class="token punctuation">,</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">const</span> originalUri <span class="token operator">=</span> document<span class="token punctuation">.</span>uri<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      virtualDocumentContents<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>
        originalUri<span class="token punctuation">,</span>
        <span class="token function">getCSSVirtualContent</span><span class="token punctuation">(</span>htmlLanguageService<span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">const</span> vdocUriString <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">embedded-content://css/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">encodeURIComponent</span><span class="token punctuation">(</span>originalUri<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.css</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> vdocUri <span class="token operator">=</span> Uri<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>vdocUriString<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">await</span> commands<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">executeCommand</span><span class="token generic class-name"><span class="token operator">&lt;</span>CompletionList<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>
        <span class="token string">&#39;vscode.executeCompletionItemProvider&#39;</span><span class="token punctuation">,</span>
        vdocUri<span class="token punctuation">,</span>
        position<span class="token punctuation">,</span>
        context<span class="token punctuation">.</span>triggerCharacter
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="潜在问题" tabindex="-1"><a class="header-anchor" href="#潜在问题" aria-hidden="true">#</a> 潜在问题</h2><hr><p>当实现嵌入语言服务器的时候，我们会遇到很多问题，到目前为止，我们也没有找到完美的方案，所以当你遇到下面的问题，可别说我们没有事先说过。</p><h3 id="很难实现语言特性" tabindex="-1"><a class="header-anchor" href="#很难实现语言特性" aria-hidden="true">#</a> 很难实现语言特性</h3><p>通常来说，围绕<strong>语言域</strong>的语言特性都是很难实现的。自动补全或者悬停信息比较容易实现，是因为你可以检测嵌入内容的语言，并计算出一个结果。但是像代码格式化、全局重命名等功能就需要特殊处理了。在格式化功能中，你需要处理缩进和多个<strong>域</strong>各自的的格式化配置问题。在重命名功能中，你也很在众多<strong>域</strong>中找到正确的替换目标。</p><h3 id="语言服务器的状态太多而无法嵌入" tabindex="-1"><a class="header-anchor" href="#语言服务器的状态太多而无法嵌入" aria-hidden="true">#</a> 语言服务器的状态太多而无法嵌入</h3><p>VS Code 的 HTML 支持提供了 HTML、CSS 和 JavaScript特性。虽然 HTML 和 CSS 的语言服务是无状态的，但是受 TypeScript 服务器加强过的 JavaScript 语言特性就不一样了。我们只在 HTML 文档中的 JavaScript 提供了基本的支持，因为在这个里面，我们很难告诉 TypeScript 这个项目状态到底是什么。比如说，如果出用 <code>&lt;script&gt;</code> 引入了一个CDN 上的 <code>lodash</code> 库，那么其他每个 <code>&lt;script&gt;</code> 脚本中都应该能够使用 <code>_.</code>自动补全。</p><h3 id="编码和解码" tabindex="-1"><a class="header-anchor" href="#编码和解码" aria-hidden="true">#</a> 编码和解码</h3><p>文件的首要语言和嵌入的语言，他们的编解码和转义规则可能完全不同。比如，根据 <a href="https://www.w3.org/TR/html401/appendix/notes.html#h-B.3.2" target="_blank" rel="noopener noreferrer">HTML 规范<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>，下面的 HTML 文档是无效的：</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>SCRIPT</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text/javascript<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  document<span class="token punctuation">.</span><span class="token function">write</span> <span class="token punctuation">(</span><span class="token string">&quot;&lt;EM&gt;This won&#39;t work&lt;/EM&gt;&quot;</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>SCRIPT</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在这个例子里，语言服务器在处理<code>&lt;/</code>时应该转义为<code>&lt;\/</code>才行。</p><h2 id="总结" tabindex="-1"><a class="header-anchor" href="#总结" aria-hidden="true">#</a> 总结</h2><hr><p>我们的这两种方法各有千秋。</p><p>语言服务：</p><ul><li><ul><li>可获完全掌控语言服务器和用户体验</li></ul></li><li><ul><li>无需依赖其他语言服务器。所有代码都在一个仓库内完成</li></ul></li><li><ul><li>语言服务器可被所有 <a href="https://microsoft.github.io/language-server-protocol/implementors/tools/" target="_blank" rel="noopener noreferrer">LSP-兼容的代码编辑器<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 重用</li></ul></li><li><ul><li>可能很难嵌入用其他语言实现的语言服务</li></ul></li><li><ul><li>需要持续维护语言服务依赖来获得新的特性</li></ul></li></ul><p>请求转发：</p><ul><li><ul><li>避免<strong>嵌入语言服务</strong>与<strong>语言服务器</strong>的非同构的问题（比如，在 Razor 语言服务器嵌入的 C# 编译器去支持 C#）</li></ul></li><li><ul><li>无需维护上游的语言服务器来获取新功能</li></ul></li><li><ul><li>无需诊断上游语言服务器的错误</li></ul></li><li><ul><li>由于缺乏控制，很难和其他语言服务器分享状态信息</li></ul></li><li><ul><li>多语言特性可能很难实现（比如，当书写 <code>&lt;div class=&quot;foo&quot;&gt;</code> 中的 <code>.foo</code>时提供 CSS 补全）</li></ul></li></ul><p>总体来说，我们还是更推荐用嵌入<strong>语言服务</strong>构建嵌入语言服务器，因为这个方法更能掌控用户体验，而且这个服务器还可被任何 LSP 兼容的编辑器复用。但是如果你的场景比较简单，无需上下文、依赖语言服务器的状态或者没有能力打包一个 Node.js 库，那么你也可以考虑使用请求转发的方式。</p></div><!----><footer class="page-meta"><!----><!----><!----></footer><nav class="page-nav"><a href="/07.language-extensions/06.language-server-extension-guide.html" class="nav-link prev" aria-label="示例：语言服务器"><div class="hint"><span class="arrow left"></span>上一页</div><div class="link"><!---->示例：语言服务器</div></a><a href="/07.language-extensions/" class="nav-link active next" aria-label="概述"><div class="hint">下一页<span class="arrow right"></span></div><div class="link">概述<!----></div></a></nav><!----><!----><!--]--></main><!--]--><footer class="footer-wrapper"><div class="footer"><a  href='http://beian.miit.gov.cn/' target='_blank'>渝ICP备17004152号-4 | Copyright ©  oorzc</a></div><!----></footer><!--]--></div><!--]--><!----><!----><!--]--></div>
    <script type="module" src="/assets/app.ed9f300c.js" defer></script>
  </body>
</html>
